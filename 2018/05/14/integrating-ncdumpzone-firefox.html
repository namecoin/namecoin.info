<!DOCTYPE html>
<html class="nojs">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Integrating ncdumpzone's Firefox TLS Mode into ncdns</title>
    <!--<meta name="description" content="Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
">-->

    <link href="/css/bootstrap.min.css" rel="stylesheet">

    <link href="/css/style.css" rel="stylesheet">
    
    <link rel="canonical" href="https://namecoin.bit/2018/05/14/integrating-ncdumpzone-firefox.html">
    <link rel="alternate" type="application/rss+xml" title="Namecoin News" href="/feed.rss"/>

    <link rel="icon" href='/images/namecoin-coin_100px.png' sizes="100x100" type="image/png">
    <link rel="icon" href='/images/namecoin-coin_200px.png' sizes="200x200" type="image/png">
    <link rel="icon" href='/images/namecoin-coin.svg' sizes="any" type="image/svg+xml">

    <script src="/js/jquery-2.2.4.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/js/remove-nojs.js"></script>
</head>


  <body>

    <header class="site-header">

        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href='/'><img src='/images/logo.png' alt="Namecoin" /></a>
                </div>
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse" tabindex="">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <div class="navbar-collapse collapse" id="navbar-collapse">
                <ul class="nav navbar-nav navbar-left">
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" tabindex="">Get Started</a>
                        <ul class="dropdown-menu">
                            <li><a href='/download/'>Download</a></li>
                            <li><a href='/get-started/name-wallets/'>Name Wallets</a></li>
                            <li><a href='/get-started/get-namecoins/'>Get Namecoins</a></li>
                            <li><a href='/docs/name-owners/'>Docs for Domain Owners</a></li>
                        </ul>
                    </li>
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" tabindex="">Dot-Bit</a>
                        <ul class="dropdown-menu">
                            <li><a href='/dot-bit/'>Home</a></li>
                            <li><a href='/dot-bit/browsing-instructions/'>Browsing Instructions</a></li>
                            <li><a href='/dot-bit/security-model/'>Security Model</a></li>
                        </ul>
                    </li>
                    <li><a href='/docs/faq/'>FAQ</a></li>
                    <li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown" tabindex="">Resources</a>
                        <ul class="dropdown-menu">
                            <li><a href='/resources/chat/'>Matrix/IRC Chat</a></li>
                            <li><a href="https://nf.bit">Forum&#10138;</a></li>
                            <li><a href='/resources/presentations/'>Presentations</a></li>
                            <li><a href='/explorers/'>Explorers</a></li>
                            <li><a href='https://metrics.namecoin.bit/'>Metrics</a></li>
                            <li><a href='/resources/whitepaper/'>Whitepaper</a></li>
                            <li><a href="https://github.com/namecoin/meta/blob/master/roadmap.md">Roadmap&#10138;</a></li>
                        </ul>
                    </li>
                    <li><a href='/team/'>Team</a></li>
                    <li><a href='/news/'>News</a></li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href='/contribute/'>Contribute</a></li>
                </ul>
                </div>
            </div>
        </nav>

</header>

<div id="fancy-graphic"><div class="container-fluid"><p id="tagline">
<span id="default-tagline">

Decentralized<br /><strong>secure</strong> names.
</span>

    <span class="candidate-tagline" hidden>
        <strong>In information</strong><br />we <strong>trust</strong>.
    </span>

    <span class="candidate-tagline" hidden>
        A <strong>trust anchor</strong><br />for the Internet.
    </span>

    <span class="candidate-tagline" hidden>
        <strong>Against<br />censorship.</strong>
    </span>

    <span class="candidate-tagline" hidden>
        <strong>Supporting<br />free speech.</strong>
    </span>

    <span class="candidate-tagline" hidden>
        Decentralized<br /><strong>secure</strong> names.
    </span>

    <span class="candidate-tagline" hidden>
        <strong>Decentralize</strong><br>all the things!
    </span>

    <span class="candidate-tagline" hidden>
        <strong>Freedom</strong><br>of information.
    </span>

</p></div></div>


    <div id="content">
      <div class="container-fluid">
        



































































































































































































































































































































































































































































<div class="post">

<header class="post-header">
<h1 class="post-title">Integrating ncdumpzone's Firefox TLS Mode into ncdns</h1>
<p class="post-meta">May 14, 2018 • Jeremy Rand <i class="fa fa-tag"></i></p>
</header>

<article class="post-content">
<p>I <a href="/2018/02/20/ncdumpzone-firefox.html">discussed in a previous post</a> some experimental work on making ncdumpzone output a Firefox certificate override list.  At that time, the procedure wasn’t exactly user-friendly: you’d need to run ncdumpzone from a terminal, redirect the output to a file, close Firefox, delete whatever existing <code class="highlighter-rouge">.bit</code> entries existed in the existing Firefox certificate override file, append the ncdumpzone output to that file, and relaunch Firefox.  I’ve now integrated some code into ncdns that can automate this procedure.</p>

<p>One of the trickier components of this was detecting whether Firefox was open.  Firefox’s documentation claims that it uses a lockfile, but as far as I can tell Firefox doesn’t actually delete its lockfile when it exits (and I’ve seen similar reports from other people).  Eventually, I decided to just watch the contents of my Firefox profile directory (sorted by Last Modified date) as Firefox opened and closed, and I noticed that Firefox’s sqlite databases produce some temporary files (specifically, files with the <code class="highlighter-rouge">.sqlite-wal</code> and <code class="highlighter-rouge">.sqlite-shm</code> extension) that are only present when Firefox is open.  So that’s a decent hack to detect that Firefox is open.</p>

<p>Given that, ncdns now creates 2 extra threads: <code class="highlighter-rouge">watchZone</code> and <code class="highlighter-rouge">watchProfile</code>.  <code class="highlighter-rouge">watchZone</code> dumps the <code class="highlighter-rouge">.bit</code> zone with ncdumpzone every 10 minutes, and makes that data available to <code class="highlighter-rouge">watchProfile</code>.  (Right now, ncdumpzone is called as a separate process, which isn’t exactly ideal – a future revision will probably refactor ncdumpzone into a library so that we can avoid this inefficiency.)  <code class="highlighter-rouge">watchProfile</code> waits for Firefox to exit (it checks at 1 Hz), and then loads Firefox’s <code class="highlighter-rouge">cert_override.txt</code> into memory, removes any existing <code class="highlighter-rouge">.bit</code> lines, appends the data from <code class="highlighter-rouge">watchZone</code>, and writes the result back to Firefox’s <code class="highlighter-rouge">cert_override.txt</code>.</p>

<p>These 2 new threads in ncdns are deliberately designed to kill ncdns if they encounter any unexpected errors.  This is because, if we stop syncing the <code class="highlighter-rouge">.bit</code> zone to the Firefox override list, Firefox will continue trusting <code class="highlighter-rouge">.bit</code> certs that might be revoked in Namecoin.  Therefore, it is important that, in such a situation, <code class="highlighter-rouge">.bit</code> domains must stop resolving until the issue is corrected.  Forcing ncdns to exit seems to be the least complex way to reliably achieve this.</p>

<p>These changes significantly improve the UX of positive TLS certificate overrides for Firefox.  A pull request to ncdns should be coming soon.</p>

<p>This work was funded by NLnet Foundation’s Internet Hardening Fund.</p>

</article>

</div>





































































































































































































































































































      </div>
    </div>

    <footer class="site-footer">

        <div class="container-fluid" id="social">
            <ul class="list-inline">
                <li><a href="https://github.com/namecoin"><i class="fa fa-github fa-2x" title="GitHub">GitHub</i></a></li>
                <li><a href="https://twitter.com/Namecoin"><i class="fa fa-twitter fa-2x" title="Twitter">Twitter</i></a></li>
                <li><a href="https://www.reddit.com/r/namecoin"><i class="fa fa-reddit-alien fa-2x" title="Reddit">Reddit</i></a></li>
                <li><a href="https://nf.bit/"><i class="fa fa-comments fa-2x" title="Forum">Forum</i></a></li>
            </ul>
        </div>

        <div class="container-fluid" id="page-source">
            <a href="https://github.com/namecoin/namecoin.org/blob/master/_posts/2018-05-14-integrating-ncdumpzone-firefox.md"><i>Submit corrections or improvements to this page</i></a>
        </div>

        <div class="container-fluid" id="page-alternate">
            <ul class="list-inline">
                <li>This page is available via:</li>
                <li><a href="https://www.namecoin.org/2018/05/14/integrating-ncdumpzone-firefox.html">DNS (namecoin.org)</a></li>
                <li><a href="https://www.rw6nbpjrmcpdxszn3air4bt7t75rpz4cp3c2kbdu72ptua57tzvin4id.onion/2018/05/14/integrating-ncdumpzone-firefox.html">Onion</a></li>
                <li><a href="http://127.0.0.1:43110/1EZSUprqJQph9JwKg3gAJtiNs899vatZTo/2018/05/14/integrating-ncdumpzone-firefox.html">ZeroNet</a></li>
                <li><a href="https://namecoin.bit/2018/05/14/integrating-ncdumpzone-firefox.html">Namecoin (namecoin.bit)</a></li>
            </ul>
        </div>

        <div class="container-fluid" id="funders">
            <p>Thanks to our funders:</p>
            
            <ul class="list-inline">
                
                    <li class="funder"><a href='https://autonomousworlds.com/'>Autonomous Worlds Ltd (Xaya)</a></li>
                
                    <li class="funder"><a href='https://nlnet.nl/internethardening/'>NLnet Foundation (Internet Hardening Fund)</a></li>
                
                    <li class="funder"><a href='https://www.f2pool.com/'>F2Pool</a></li>
                
                    <li class="funder">Handshake</li>
                
                    <li class="funder">Cyphrs</li>
                
                    <li class="funder"><a href='https://www.cyphermarket.com/'>Cypher Market</a></li>
                
                    <li class="funder"><a href='https://cyberia.club/'>Cyberia Computer Club</a></li>
                
                    <li class="funder">European Commission Directorate-General for Communications Networks, Content and Technology (via Next Generation Internet Zero: Search and Discovery)</li>
                
                    <li class="funder"><a href='https://nlnet.nl/discovery/'>NLnet Foundation (Next Generation Internet Zero: Search and Discovery)</a></li>
                
                    <li class="funder">Netherlands Ministry of Economic Affairs (via Internet Hardening Fund)</li>
                
            </ul>
        </div>
</footer>


  </body>

</html>
